// Prisma Schema - PostgreSQL Version
// Ultra-fast replacement for MongoDB

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── User Model ───────────────────────────────────────────
model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Basic Info
  fullName  String
  email     String   @unique
  username  String   @unique
  nickname  String?
  bio       String?
  password  String
  profilePic String?

  // Profile Status
  hasCompletedProfile Boolean @default(false)
  isVerified         Boolean @default(false)
  isBlocked          Boolean @default(false)
  isSuspended        Boolean @default(false)

  // Location Data
  country     String?
  countryCode String?
  city        String?
  region      String?
  timezone    String?
  isVPN       Boolean @default(false)
  lastIP      String?

  // Online Status
  isOnline Boolean   @default(false)
  lastSeen DateTime?

  // Verification Request
  verificationStatus    String   @default("none") // none, pending, approved, rejected
  verificationReason    String?
  verificationIdProof   String?
  verificationRequestedAt DateTime?
  verificationReviewedAt  DateTime?
  verificationReviewedBy  String?
  verificationAdminNote   String?

  // Suspension
  suspensionReason    String?
  suspensionStartTime DateTime?
  suspensionEndTime   DateTime?
  suspensionDuration  Int?

  // Password Reset
  resetPasswordToken  String?
  resetPasswordExpire DateTime?

  // Email Change
  emailChangeOTP        String?
  emailChangeOTPExpires DateTime?
  pendingEmail          String?

  // Username Change Tracking
  lastUsernameChange       DateTime?
  usernameChangesThisWeek  Int      @default(0)
  weekStartDate            DateTime?
  usernameChangeHistory    Json     @default("[]")

  // Password Change
  passwordChangeOTP        String?
  passwordChangeOTPExpires DateTime?

  // Relationships
  friends                String[] // Array of user IDs
  friendRequestsSent     String[] // Array of user IDs
  friendRequestsReceived String[] // Array of user IDs

  // Relations
  sentMessages     Message[]       @relation("SentMessages")
  receivedMessages Message[]       @relation("ReceivedMessages")
  sentReports      Report[]        @relation("ReportSender")
  receivedReports  Report[]        @relation("ReportedUser")
  sentFriendRequests     FriendRequest[] @relation("FriendRequestSender")
  receivedFriendRequests FriendRequest[] @relation("FriendRequestReceiver")

  @@index([email])
  @@index([username])
  @@index([isOnline])
  @@index([country])
  @@index([verificationStatus])
  @@index([createdAt])
}

// ─── Message Model ────────────────────────────────────────
model Message {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  text      String?
  image     String?
  voice     String?
  voiceDuration Int?

  senderId   String
  receiverId String

  sender   User @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  // Message status (WhatsApp-style)
  status        String   @default("sent") // sent, delivered, read
  deliveredAt   DateTime?
  readAt        DateTime?

  // Call logs
  isCallLog      Boolean @default(false)
  callType       String? // voice, video
  callDuration   Int?
  callStatus     String? // completed, missed, rejected
  callInitiator  String?

  // Reactions
  reactions Json @default("[]") // Array of {emoji, userId, createdAt}

  // Reply To
  replyToId String?
  isDeleted Boolean @default(false)
  deletedAt DateTime?

  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
}

// ─── Friend Request Model ─────────────────────────────────
model FriendRequest {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  senderId   String
  receiverId String

  sender   User @relation("FriendRequestSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("FriendRequestReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId])
  @@index([senderId])
  @@index([receiverId])
}

// ─── Report Model ─────────────────────────────────────────
model Report {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reporterId String
  reportedUserId String
  reason     String
  description String?
  status     String   @default("pending") // pending, reviewed, resolved, dismissed
  screenshot String?  // Screenshot URL for AI-detected reports
  
  // AI Analysis
  isAIDetected Boolean @default(false)
  aiCategory   String?  // Category detected by AI
  aiConfidence Float?   // AI confidence score (0-1)
  aiAnalysis   Json?
  severity     String?  // low, medium, high, critical
  category     String?  // harassment, spam, inappropriate, etc.
  actionTaken  String?  // Action taken by admin
  
  reviewedBy String?
  reviewedAt DateTime?
  adminNotes String?

  reporter     User @relation("ReportSender", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedUser User @relation("ReportedUser", fields: [reportedUserId], references: [id], onDelete: Cascade)

  @@index([reporterId])
  @@index([reportedUserId])
  @@index([status])
  @@index([createdAt])
}

// ─── Admin Notification Model ─────────────────────────────
model AdminNotification {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  type      String   // report, verification, user_action
  title     String
  message   String
  isRead    Boolean  @default(false)
  link      String?
  metadata  Json?

  @@index([isRead])
  @@index([createdAt])
}
