import{c as pe,q as be,s as xe,t as we,u as Se,n as ye,a as Re,r as o,_ as p,j as r,L as ae,P as ve,p as Ne,S as Ce}from"./index-BZ0hST_k.js";import{T as Ie}from"./triangle-alert-BIdojJ6r.js";import{U as je}from"./user-plus-D_28Q8fX.js";/**
 * @license lucide-react v0.459.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=pe("SkipForward",[["polygon",{points:"5 4 15 12 5 20 5 4",key:"16p6eg"}],["line",{x1:"19",x2:"19",y1:"5",y2:"19",key:"futhcm"}]]);let I=null,P=!1,z=null;const ce=async()=>{if(I)return console.log("âœ… NSFW model already loaded"),I;if(P)return console.log("â³ NSFW model is loading..."),null;P=!0,console.log("ğŸ”„ Loading NSFW detection model...");try{return await be(),console.log("âœ… TensorFlow.js backend ready:",xe()),I=await we(),console.log("âœ… NSFW detection model loaded successfully"),z=null,I}catch(s){return console.error("âŒ Failed to load NSFW model:",s),z=s.message,null}finally{P=!1}},Te=async s=>{try{if(!I&&!P&&(console.log("ğŸ”„ Model not loaded, initializing..."),await ce()),P)return console.log("â³ Waiting for model to load..."),{safe:!0,confidence:0,loading:!0};if(!I)return console.warn("âš ï¸ NSFW model not available:",z),{safe:!0,confidence:0,error:z};if(!s||s.readyState<2)return console.log("â³ Video not ready yet"),{safe:!0,confidence:0,videoNotReady:!0};console.log("ğŸ” Analyzing frame...");const e=await I.classify(s);console.log("ğŸ“Š AI Predictions:",e.map(l=>`${l.className}: ${(l.probability*100).toFixed(1)}%`).join(", ")),console.log("ğŸ“¹ Video state:",{width:s.videoWidth,height:s.videoHeight,readyState:s.readyState,paused:s.paused});const R=e.filter(l=>["Hentai","Porn"].includes(l.className)&&l.probability>.3),x=e.filter(l=>l.className==="Sexy"&&l.probability>.4),b=R.length>0,c=x.length>0,u={safe:!b&&!c,inappropriate:b,suspicious:c,predictions:e,highestRisk:e.reduce((l,f)=>f.probability>l.probability?f:l)};return u.safe||console.warn("âš ï¸ UNSAFE CONTENT DETECTED:",u.highestRisk),u}catch(e){return console.error("âŒ Frame analysis error:",e),{safe:!0,confidence:0,error:e.message}}},se=s=>{try{const e=document.createElement("canvas");return e.width=s.videoWidth,e.height=s.videoHeight,e.getContext("2d").drawImage(s,0,0),e.toDataURL("image/jpeg",.8)}catch(e){return console.error("Frame capture error:",e),null}},C={enabled:!0,checkInterval:5e3,silentReportThreshold:.05,confidenceThreshold:.4,autoReportThreshold:.65,maxViolations:2},Ee=["Nudity or Sexual Content","Harassment or Hate Speech","Spam or Scams","Threatening Behavior","Underage User","Other"],Fe=({isOpen:s,onClose:e,onSubmit:R,screenshotPreview:x,isSubmitting:b})=>{const[c,u]=o.useState("");if(o.useEffect(()=>{s&&u("")},[s]),!s)return null;const l=f=>{if(f.preventDefault(),!c){p.error("Please select a reason.");return}R(c)};return r.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:r.jsxs("div",{className:"bg-base-100 p-6 rounded-lg shadow-xl w-full max-w-md",children:[r.jsx("h2",{className:"text-xl font-bold mb-4",children:"Report User"}),r.jsx("p",{className:"text-sm mb-4 text-base-content/80",children:"A screenshot will be sent for review."}),x&&r.jsx("div",{className:"mb-4 border border-base-300 rounded overflow-hidden",children:r.jsx("img",{src:x,alt:"Report Screenshot",className:"max-h-40 w-full object-contain bg-black",loading:"lazy",decoding:"async"})}),r.jsxs("form",{onSubmit:l,children:[r.jsxs("div",{className:"form-control mb-4",children:[r.jsx("label",{className:"label",children:r.jsx("span",{className:"label-text",children:"Reason:"})}),r.jsxs("select",{className:"select select-bordered w-full",value:c,onChange:f=>u(f.target.value),required:!0,children:[r.jsx("option",{value:"",disabled:!0,children:"Select a reason"}),Ee.map(f=>r.jsx("option",{value:f,children:f},f))]})]}),r.jsxs("div",{className:"flex justify-end gap-3 mt-6",children:[r.jsx("button",{type:"button",className:"btn btn-ghost",onClick:e,disabled:b,children:"Cancel"}),r.jsx("button",{type:"submit",className:"btn btn-error",disabled:b||!c,children:b?r.jsx(ae,{className:"animate-spin"}):"Submit Report"})]})]})]})})},Ue=()=>{const{authUser:s,socket:e}=Se(),{getFriendshipStatus:R,fetchFriendData:x}=ye(),b=Re(),[c,u]=o.useState("idle");o.useState(!1);const[l,f]=o.useState([]),[F,Y]=o.useState(""),[g,J]=o.useState(null),[Ae,X]=o.useState(null),[j,U]=o.useState("NOT_FRIENDS"),[ie,q]=o.useState(!1),[L,le]=o.useState(null),[de,V]=o.useState(!1),[H,Q]=o.useState(!1),k=o.useRef(null),w=o.useRef(null),O=o.useRef(null),A=o.useRef(null),i=o.useRef(null),N=o.useRef([]),T=o.useCallback((t,n)=>{f(d=>[...d,{sender:t,message:n}])},[]),W=o.useCallback(()=>{console.log("WebRTC: Creating PeerConnection");const t=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]});return t.onicecandidate=n=>{n.candidate&&e&&e.emit("webrtc:ice-candidate",{candidate:n.candidate})},t.ontrack=n=>{n.streams&&n.streams[0]&&(console.log("WebRTC: Received remote track"),O.current=n.streams[0],i.current&&(i.current.srcObject=n.streams[0]))},w.current&&w.current.getTracks().forEach(n=>{t.addTrack(n,w.current)}),k.current=t,N.current=[],t},[e]),K=o.useCallback(async()=>{if(console.log("WebRTC: Starting call as initiator"),!w.current){console.error("No local stream!");return}try{const t=W(),n=await t.createOffer();await t.setLocalDescription(n),console.log("WebRTC: Sending offer"),e.emit("webrtc:offer",{sdp:n})}catch(t){console.error("Error creating offer:",t)}},[W,e]),Z=o.useCallback(async t=>{if(console.log("WebRTC: Received offer, creating answer"),!w.current){console.error("No local stream for answer!");return}try{const n=W();await n.setRemoteDescription(new RTCSessionDescription(t));const d=await n.createAnswer();await n.setLocalDescription(d),console.log("WebRTC: Sending answer"),e.emit("webrtc:answer",{sdp:d}),N.current.forEach(S=>{n.addIceCandidate(new RTCIceCandidate(S)).catch(E=>console.error("ICE error:",E))}),N.current=[]}catch(n){console.error("Error handling offer:",n)}},[W,e]),ee=o.useCallback(async t=>{console.log("WebRTC: Received answer");const n=k.current;if(n)try{await n.setRemoteDescription(new RTCSessionDescription(t)),N.current.forEach(d=>{n.addIceCandidate(new RTCIceCandidate(d)).catch(S=>console.error("ICE error:",S))}),N.current=[]}catch(d){console.error("Error handling answer:",d)}},[]),te=o.useCallback(async t=>{if(!t)return;const n=k.current;if(!n||!n.remoteDescription)N.current.push(t);else try{await n.addIceCandidate(new RTCIceCandidate(t))}catch(d){console.error("Error adding ICE candidate:",d)}},[]),_=o.useCallback(()=>{console.log("WebRTC: Closing connection"),k.current&&(k.current.close(),k.current=null),O.current&&(O.current.getTracks().forEach(t=>t.stop()),O.current=null),i.current&&(i.current.srcObject=null),f([]),J(null),X(null),U("NOT_FRIENDS"),N.current=[]},[]);o.useEffect(()=>{if(g){const t=R(g);U(t),x()}else U("NOT_FRIENDS")},[g,R,x]),o.useEffect(()=>{if(!e||!s){p.error("Connection error."),b("/");return}let t=!0,n=!1;(async()=>{try{const a=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});if(!t){a.getTracks().forEach($=>$.stop());return}w.current=a,A.current&&(A.current.srcObject=a),u("waiting"),n||(e.emit("stranger:joinQueue",{userId:s._id}),n=!0)}catch(a){console.error("Permission denied:",a),p.error("Camera and microphone access required for stranger chat"),b("/")}})();const S=()=>{t&&u("waiting")},E=a=>{if(console.log("Socket: matched with",a.partnerId,"User ID:",a.partnerUserId),t){T("System","Partner found!"),u("connected"),J(a.partnerUserId),X(a.partnerUserData);const $=e.id<a.partnerId;console.log(`Should I initiate? ${$}`),$&&setTimeout(()=>K(),1e3)}},D=()=>{t&&(T("System","Partner disconnected."),_(),u("waiting"),e.emit("stranger:joinQueue",{userId:s._id}))},M=a=>{t&&T("Stranger",a.message)},m=()=>{t&&(p.success("Stranger sent you a friend request!"),x())},h=()=>{t&&(p.success("Friend request sent!"),x())},y=a=>{console.log("Socket: received offer"),t&&Z(a.sdp)},G=a=>{console.log("Socket: received answer"),t&&ee(a.sdp)},v=a=>{t&&te(a.candidate)},re=({error:a})=>{t&&(p.error(a),U(R(g)))},ne=({message:a})=>{t&&(p.success(a),V(!1),q(!1))},oe=({error:a})=>{t&&(p.error(a),V(!1))};return e.on("stranger:waiting",S),e.on("stranger:matched",E),e.on("stranger:disconnected",D),e.on("stranger:chatMessage",M),e.on("stranger:friendRequest",m),e.on("stranger:friendRequestSent",h),e.on("webrtc:offer",y),e.on("webrtc:answer",G),e.on("webrtc:ice-candidate",v),e.on("stranger:addFriendError",re),e.on("stranger:reportSuccess",ne),e.on("stranger:reportError",oe),()=>{t=!1,u("idle"),w.current&&(w.current.getTracks().forEach(a=>a.stop()),w.current=null),A.current&&(A.current.srcObject=null),_(),e&&e.connected&&e.emit("stranger:skip"),e.off("stranger:waiting",S),e.off("stranger:matched",E),e.off("stranger:disconnected",D),e.off("stranger:chatMessage",M),e.off("stranger:friendRequest",m),e.off("stranger:friendRequestSent",h),e.off("webrtc:offer",y),e.off("webrtc:answer",G),e.off("webrtc:ice-candidate",v),e.off("stranger:addFriendError",re),e.off("stranger:reportSuccess",ne),e.off("stranger:reportError",oe)}},[e,s,b,T,_,K,Z,ee,te,x]),o.useEffect(()=>{console.log("ğŸš€ Initializing AI moderation model..."),Q(!1),ce().then(()=>{console.log("âœ… AI moderation ready"),Q(!0)}).catch(t=>{console.error("âŒ Failed to initialize AI moderation:",t),Q(!1)})},[]),o.useEffect(()=>{if(c!=="connected"||!i.current||!g)return;let t=0,n,d=0;const S=async()=>{var D,M;try{if(d++,console.log(`ğŸ” AI Check #${d} - Status: ${c}`),!i.current||i.current.readyState<2){console.log("â³ Video not ready yet, skipping check");return}const m=await Te(i.current);if(m.loading||m.videoNotReady){console.log("â³ Skipping check - model loading or video not ready");return}if(m.error){console.error("âŒ Analysis error:",m.error);return}const h=((D=m.highestRisk)==null?void 0:D.probability)||0,y=((M=m.highestRisk)==null?void 0:M.className)||"Unknown";if(["Porn","Hentai","Sexy"].includes(y)&&h>=C.silentReportThreshold&&h<C.confidenceThreshold){console.log(`ğŸ“‹ SILENT REPORT to admin - Low confidence: ${(h*100).toFixed(1)}%`);const v=se(i.current);v&&e&&e.emit("stranger:aiSuspicion",{reporterId:s._id,reportedUserId:g,reason:"AI Suspicion - Low Confidence",description:`AI detected suspicious content: ${y} (${(h*100).toFixed(1)}% confidence)

This is a low-confidence detection for admin review only. No action taken against user.`,screenshot:v,category:"stranger_chat",isAIDetected:!0,aiConfidence:h,aiCategory:y,isSilentReport:!0})}if(m.safe)console.log("âœ… Content check passed - safe");else if(t++,console.warn("âš ï¸ AI Moderation Alert:",{violations:t,confidence:`${(h*100).toFixed(1)}%`,category:y,allPredictions:m.predictions}),h>=C.autoReportThreshold){console.log("ğŸš¨ AUTO-REPORTING due to high confidence");const v=se(i.current);v&&e&&e.emit("stranger:report",{reporterId:s._id,reportedUserId:g,reason:"Nudity or Sexual Content",description:`AI detected: ${y} (${(h*100).toFixed(1)}% confidence)`,screenshot:v,category:"stranger_chat",isAIDetected:!0,aiConfidence:h,aiCategory:y}),p.error("Inappropriate content detected. Disconnecting and reporting."),B()}else t>=C.maxViolations?(console.log("ğŸš¨ DISCONNECTING due to multiple violations"),p.error("Multiple content violations detected. Disconnecting."),B()):p.warning(`Warning: Potentially inappropriate content detected (${t}/${C.maxViolations})`)}catch(m){console.error("âŒ AI Moderation error:",m)}};console.log("â° Starting AI moderation checks in 3 seconds...");const E=setTimeout(()=>{console.log(`âœ… AI moderation active - checking every ${C.checkInterval/1e3}s`),S(),n=setInterval(S,C.checkInterval)},3e3);return()=>{console.log("ğŸ›‘ Stopping AI moderation checks"),clearTimeout(E),n&&clearInterval(n)}},[c,g,s,e]);const B=()=>{c!=="idle"&&(c==="connected"&&T("System","Skipping..."),e.emit("stranger:skip"),_(),u("waiting"))},ue=t=>{t.preventDefault(),!(!F.trim()||c!=="connected")&&(e.emit("stranger:chatMessage",{message:F}),T("You",F),Y(""))},fe=()=>{c!=="connected"||!g||e.emit("stranger:addFriend",{partnerUserId:g})},me=()=>{if(!i.current||i.current.videoWidth===0)return p.error("Cannot capture screenshot."),null;const t=document.createElement("canvas");return t.width=i.current.videoWidth,t.height=i.current.videoHeight,t.getContext("2d").drawImage(i.current,0,0),t.toDataURL("image/jpeg")},ge=()=>{const t=me();t&&(le(t),q(!0))},he=t=>{!L||!t||!g||(V(!0),e.emit("stranger:report",{reporterId:s._id,reportedUserId:g,reason:t,description:"Reported from stranger chat",screenshot:L,category:"stranger_chat"}))};return r.jsxs("div",{className:"h-screen pt-12 xs:pt-14 sm:pt-16 flex flex-col bg-gradient-to-br from-base-300 via-base-200 to-base-300",children:[r.jsxs("div",{className:"flex-1 flex flex-col md:flex-row gap-3 p-3 md:p-4 overflow-hidden",children:[r.jsx("div",{className:"flex-1 flex flex-col relative overflow-hidden bg-gradient-to-b from-black to-gray-900 rounded-xl md:rounded-2xl shadow-2xl border border-base-content/10",children:r.jsxs("div",{className:"w-full h-full relative rounded-xl md:rounded-2xl overflow-hidden",children:[r.jsx("video",{ref:i,autoPlay:!0,playsInline:!0,className:"w-full h-full object-cover md:object-contain"}),c==="waiting"&&r.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center text-white gap-4 bg-gradient-to-b from-black/90 to-black/70 backdrop-blur-sm",children:[r.jsx(ae,{className:"w-14 h-14 md:w-20 md:h-20 animate-spin text-primary drop-shadow-lg"}),r.jsx("p",{className:"text-lg md:text-2xl font-bold drop-shadow-lg",children:"Finding a partner..."})]}),c==="connected"&&r.jsxs(r.Fragment,{children:[r.jsxs("button",{onClick:ge,className:"btn btn-error btn-xs md:btn-sm absolute top-3 right-3 opacity-90 hover:opacity-100 z-20 flex items-center gap-1 shadow-xl backdrop-blur-sm",children:[r.jsx(Ie,{size:14})," Report"]}),r.jsxs("div",{className:`absolute top-3 left-3 z-20 px-2 py-1 rounded-full text-xs font-semibold flex items-center gap-1 backdrop-blur-sm ${H?"bg-green-500/90 text-white":"bg-yellow-500/90 text-black"}`,children:[r.jsx("span",{className:`w-2 h-2 rounded-full ${H?"bg-white animate-pulse":"bg-black"}`}),H?"AI Protected":"AI Loading..."]})]}),r.jsx("div",{className:"w-20 h-28 md:w-44 md:h-auto md:aspect-video lg:w-52 bg-gradient-to-b from-gray-800 to-black rounded-lg md:rounded-xl overflow-hidden absolute bottom-3 right-3 md:bottom-4 md:right-4 border-2 border-primary shadow-2xl z-20 ring-2 ring-primary/20",children:r.jsx("video",{ref:A,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover",style:{transform:"scaleX(-1)"}})})]})}),r.jsxs("div",{className:"w-full md:w-80 lg:w-96 h-[40vh] md:h-full flex flex-col bg-gradient-to-b from-base-100 to-base-200 rounded-xl md:rounded-2xl shadow-2xl overflow-hidden border border-base-content/10",children:[r.jsxs("div",{className:"flex items-center gap-2 p-3 border-b border-base-300 bg-gradient-to-r from-base-200 to-base-100",children:[r.jsxs("button",{onClick:B,className:"btn btn-primary btn-sm flex-1 gap-1 shadow-md hover:shadow-lg transition-all",disabled:c==="idle",children:[r.jsx(ke,{size:16})," ",c==="connected"?"Skip":"Find"]}),r.jsxs("button",{onClick:()=>b("/"),className:"btn btn-error btn-sm gap-1 shadow-md hover:shadow-lg transition-all",children:[r.jsx(ve,{size:16})," Leave"]})]}),r.jsx("div",{className:"p-3 border-b border-base-300",children:r.jsxs("button",{className:"btn btn-secondary btn-sm w-full gap-1 shadow-md hover:shadow-lg transition-all",disabled:c!=="connected"||j==="REQUEST_SENT"||j==="FRIENDS",onClick:fe,children:[r.jsx(je,{size:16}),j==="NOT_FRIENDS"&&"Add Friend",j==="REQUEST_SENT"&&"Request Sent",j==="REQUEST_RECEIVED"&&"Pending Request",j==="FRIENDS"&&"Friends"]})}),r.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[r.jsx("div",{className:"p-3 pb-0",children:r.jsxs("h3",{className:"text-sm font-bold mb-3 flex items-center gap-2 text-primary",children:[r.jsx(Ne,{size:18})," Temp Chat"]})}),r.jsx("div",{className:"flex-1 overflow-y-auto px-3 space-y-2 scrollbar-thin scrollbar-thumb-primary/40 scrollbar-track-transparent",children:l.map((t,n)=>r.jsx("div",{className:`chat ${t.sender==="You"?"chat-end":"chat-start"}`,children:r.jsx("div",{className:`chat-bubble text-xs md:text-sm py-2 px-3 shadow-md ${t.sender==="You"?"chat-bubble-primary":t.sender==="System"?"chat-bubble-accent":"chat-bubble-secondary"}`,children:t.message})},n))}),r.jsxs("form",{onSubmit:ue,className:"flex gap-2 p-3 bg-base-100 border-t border-base-300 sticky bottom-0 z-10",style:{paddingBottom:"max(12px, env(safe-area-inset-bottom))"},children:[r.jsx("input",{type:"text",placeholder:"Type a message...",className:"input input-sm input-bordered flex-1 text-sm bg-base-200 focus:ring-2 focus:ring-primary/50 transition-all",value:F,onChange:t=>Y(t.target.value),disabled:c!=="connected"}),r.jsx("button",{type:"submit",className:"btn btn-primary btn-sm btn-circle shadow-md hover:shadow-lg transition-all",disabled:c!=="connected"||!F.trim(),children:r.jsx(Ce,{size:16})})]})]})]})]}),r.jsx(Fe,{isOpen:ie,onClose:()=>q(!1),onSubmit:he,screenshotPreview:L,isSubmitting:de})]})};export{Ue as default};
